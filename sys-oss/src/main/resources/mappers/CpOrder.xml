<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sys.dao.CpOrderDao">
    <!--CP订单表-->
    <sql id="table">cp_order</sql>

    <sql id="base_columns">
        ${alias}`cp_id`,
        ${alias}`app_id`,
        ${alias}`keyword`,
        ${alias}`start_time`,
        ${alias}`end_time`,
        ${alias}`unit_price`,
        ${alias}`cnt`,
        ${alias}`complete_cnt`,
        ${alias}`create_time`
    </sql>

    <sql id="find_columns">
        ${alias}`id`,
        <include refid="base_columns"/>
    </sql>

    <resultMap id="resultMap" type="com.ayl.advert.model.CpOrder">
        <id property="id" column="id"/>
    </resultMap>

    <select id="get" resultMap="resultMap">
        select
        <include refid="find_columns">
            <property name="alias" value="t."/>
        </include>
        from
        <include refid="table"/>
        t
        where
        id=#{id}
    </select>

    <sql id="insert_columns">(
        <include refid="base_columns">
            <property name="alias" value=""/>
        </include>
        )
    </sql>

    <sql id="insert_values">(
        #{cp_id},
        #{app_id},
        #{keyword},
        #{start_time},
        #{end_time},
        #{unit_price},
        #{cnt},
        #{complete_cnt},
        #{create_time}
      )
    </sql>

    <sql id="update_columns">
        cp_id=#{cp_id},
        app_id=#{app_id},
        keyword=#{keyword},
        start_time=#{start_time},
        end_time=#{end_time},
        unit_price=#{unit_price},
        cnt=#{cnt},
        <!-- complete_cnt=#{complete_cnt},-->
        create_time=#{create_time}
    </sql>


    <insert id="save" useGeneratedKeys="true" keyProperty="id">
        insert into
        <include refid="table"/>
        <include refid="insert_columns"/>
        values
        <include refid="insert_values"/>
    </insert>

    <update id="update">
        update
        <include refid="table"/>
        <set>
            <include refid="update_columns"/>
        </set>
        where
        id=#{id}
    </update>


    <sql id="where">
        <where>
            <if test="query.id!=null">
                and t.id =#{query.id}
            </if>
            <if test="query.cp_id!=null">
                and t.cp_id =#{query.cp_id}
            </if>
            <if test="query.app_id!=null">
                and t.app_id =#{query.app_id}
            </if>
            <if test="query.start_time!=null and query.start_time!=''">
                and t.start_time &gt;=#{query.start_time}
            </if>
            <if test="query.end_time!=null and query.end_time!=''">
                and t.end_time &lt;=#{query.end_time}
            </if>
            <if test="query.keyword!=null and query.keyword!=''">
                and t.keyword like CONCAT('%',#{query.keyword},'%')
            </if>
        </where>
    </sql>


    <select id="findCnt" resultType="Long">
        select
        count(1)
        from
        <include refid="table"/>
        t
        <include refid="where"/>
    </select>

    <select id="find" resultType="java.util.HashMap">
        select
        <include refid="find_columns">
            <property name="alias" value="t."/>
        </include>
        ,
        t2.name as app_name,
        t2.icon as app_icon
        from
        <include refid="table"/>
        t
        inner join app_info t2 on t.app_id=t2.app_id
        <include refid="where"/>
        order by t.id desc
        limit ${start},${limit}
    </select>
    
    <insert id="increaseCompleteCnt">
        update <include refid="table"/> set complete_cnt=complete_cnt+#{cnt} where id=#{id}
    </insert>

</mapper>